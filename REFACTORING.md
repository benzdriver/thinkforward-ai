# ThinkForward AI 重构计划与进度追踪

**文档创建日期:** 2024-06-15  
**最后更新:** 2024-06-27

## 🎯 重构目标

基于对现有代码的分析，本重构计划旨在解决以下核心问题：

1. 提高代码质量与可维护性
2. 统一用户体验与设计语言
3. 优化性能与加载时间
4. 增强安全性与错误处理
5. 完善国际化支持

## 🚀 重构优先级

### 第一阶段：基础架构优化（预计2周）

1. **认证与授权系统重构**
   - [x] 统一角色管理API端点
   - [x] 创建集中式权限控制系统
   - [x] 移除重复的AuthenticatedApp组件
   - [ ] 实现基于订阅的功能访问控制

2. **组件库建设**
   - [x] 提取共用UI组件（表格、表单、按钮等）
   - [🔄] 创建标准布局组件
   - [x] 实现统一的加载状态指示器
   - [x] 开发全局错误处理组件
   - [x] 优化组件以支持国际化
   - [🔄] 统一组件导出方式（使用命名导出）

3. **状态管理优化**
   - [🔄] 引入React Query进行数据获取与缓存
   - [🔄] 创建可复用的自定义hooks
   - [🔄] 优化组件渲染性能

### 第二阶段：功能与体验优化（预计3周）

4. **国际化完善**
   - [x] 移除硬编码文本
   - [🔄] 完善翻译文件（支持简体中文、繁体中文、英语、法语、日语、韩语、阿拉伯语）
   - [x] 实现语言切换功能
   - [🔄] 支持RTL布局（阿拉伯语等）
   - [x] 支持日期、数字等本地化格式
   - [x] 重构翻译文件结构（按页面组织）

5. **响应式设计优化**
   - [🔄] 修复移动端布局问题
   - [🔄] 优化表格在小屏幕上的显示
   - [🔄] 实现更好的触摸体验

6. **用户体验改进**
   - [🔄] 增强表单验证与反馈
   - [🔄] 优化状态转换的视觉反馈
   - [ ] 改进导航结构
   - [ ] 实现更直观的错误提示

7. **认证页面重构** [新增]
   - [🔄] 登录页面重构
   - [🔄] 注册页面重构
   - [ ] 密码重置页面重构
   - [ ] 账户验证页面重构

8. **用户管理界面重构** [新增]
   - [ ] 用户资料设置页面
   - [ ] 账户管理页面
   - [ ] 订阅管理页面

9. **主登陆页面重构** [新增]
   - [ ] 营销内容更新
   - [ ] 功能展示优化
   - [ ] 价格方案页面
   - [ ] 联系表单改进

### 第三阶段：安全与性能（预计2周）

10. **安全增强**
    - [ ] 审查并加强API权限控制
    - [ ] 实现更安全的日志记录
    - [ ] 添加CSRF保护
    - [ ] 审查数据暴露风险

11. **性能优化**
    - [ ] 实现数据分页与懒加载
    - [ ] 优化图片与资源加载
    - [ ] 减少不必要的API请求
    - [ ] 实现组件懒加载

12. **测试覆盖**
    - [ ] 为核心组件添加单元测试
    - [ ] 实现关键用户流程的端到端测试
    - [ ] 设置CI/CD测试流程

## 📊 重构进度跟踪

| 任务 | 状态 | 负责人 | 开始日期 | 完成日期 | 备注 |
|------|------|--------|----------|----------|------|
| 统一角色管理API | 完成 | 开发团队 | 2024-06-16 | 2024-06-16 | 合并了`/api/user/role.ts`和`/api/users/role.ts`，创建了统一的useUserRole hook |
| 创建集中式权限系统 | 完成 | 开发团队 | 2024-06-17 | 2024-06-17 | 创建了权限中间件、客户端权限hook和权限保护组件 |
| 移除重复的AuthenticatedApp | 完成 | 开发团队 | 2024-06-18 | 2024-06-18 | 提取了AuthenticatedApp到单独组件，添加了ErrorBoundary和LoadingScreen |
| 提取共用UI组件 | 完成 | 开发团队 | 2024-06-19 | 2024-06-19 | 创建了DataTable、Form、Button、Card、Alert、Modal、Tabs、Pagination和Empty组件 |
| 优化组件以支持国际化 | 完成 | 开发团队 | 2024-06-21 | 2024-06-25 | 创建了i18n工具函数，更新了所有UI组件以支持国际化，移除了硬编码文本 |
| 统一组件导出方式 | 进行中 | 开发团队 | 2024-06-22 | - | 将所有组件改为使用命名导出，移除默认导出 |
| 引入React Query | 进行中 | 开发团队 | 2024-06-24 | - | 添加了@tanstack/react-query依赖，创建了查询客户端配置，开发了基础数据获取hooks |
| 创建可复用自定义hooks | 进行中 | 开发团队 | 2024-06-24 | - | 创建了useToast、useForm、useModal等自定义hooks |
| 优化组件渲染性能 | 进行中 | 开发团队 | 2024-06-25 | - | 使用React.memo优化组件，减少不必要的重渲染 |
| 移除硬编码文本 | 完成 | 开发团队 | 2024-06-21 | 2024-06-25 | 已移除UI组件中的所有硬编码文本，替换为翻译函数 |
| 完善翻译文件 | 进行中 | 开发团队 | 2024-06-21 | - | 已完成英文和简体中文翻译文件，其他语言待添加 |
| 实现语言切换功能 | 完成 | 开发团队 | 2024-06-21 | 2024-06-25 | 创建了LanguageSwitcher组件，实现了语言切换和偏好保存 |
| 支持RTL布局 | 进行中 | 开发团队 | 2024-06-22 | - | 创建了RTLWrapper组件和RTL样式 |
| 修复移动端布局 | 进行中 | 开发团队 | 2024-06-25 | - | 修复了主要页面的移动端布局问题 |
| 优化表格在小屏幕上的显示 | 进行中 | 开发团队 | 2024-06-25 | - | 为DataTable组件添加了响应式设计 |
| 实现更好的触摸体验 | 进行中 | 开发团队 | 2024-06-25 | - | 优化了按钮和表单控件的触摸区域 |
| 增强表单验证与反馈 | 进行中 | 开发团队 | 2024-06-26 | - | 创建了FormField组件，实现了统一的表单验证与反馈 |
| 优化状态转换的视觉反馈 | 进行中 | 开发团队 | 2024-06-26 | - | 创建了ActionButton组件，提供加载状态视觉反馈 |
| 登录页面重构 | 进行中 | 开发团队 | 2024-06-26 | - | 使用新的UI组件和国际化支持重构登录页面 |
| 注册页面重构 | 进行中 | 开发团队 | 2024-06-26 | - | 使用新的UI组件和国际化支持重构注册页面 |
| 创建标准布局组件 | 进行中 | 开发团队 | 2024-06-23 | - | 创建了AppLayout、AuthenticatedLayout、ConsultantLayout等布局组件 |
| 重构翻译文件结构 | 完成 | 开发团队 | 2024-06-27 | 2024-06-27 | 将翻译文件按页面组织，优化国际化支持 |
| 支持日期、数字本地化格式 | 完成 | 开发团队 | 2024-06-27 | 2024-06-27 | 使用Intl API实现日期和数字的本地化格式 |
| 审查API权限控制 | 未开始 | - | - | - | - |
| 实现数据分页 | 未开始 | - | - | - | - |
| 添加核心组件测试 | 未开始 | - | - | - | - |

## 🔍 详细任务分解

### 1. 认证与授权系统重构

#### 统一角色管理API ✅
- 合并了 `/api/user/role.ts` 和 `/api/users/role.ts`
- 创建了统一的 `useUserRole` hook
- 确保API返回一致的响应格式

#### 创建集中式权限控制系统 ✅
- 创建了 `withPermission` 中间件用于API权限控制
- 实现了 `usePermission` hook用于客户端权限检查
- 开发了 `PermissionGuard` 组件用于保护UI元素
- 创建了 `withPagePermission` HOC用于保护整个页面
- 建立了基于角色和订阅的权限映射系统

#### 移除重复的AuthenticatedApp组件 ✅
- 提取 `AuthenticatedApp` 组件到单独文件
- 创建了 `LoadingScreen` 组件用于统一加载状态显示
- 添加了 `ErrorBoundary` 组件用于全局错误处理
- 更新了 `_app.tsx` 以使用新的组件结构

### 2. 组件库建设

#### 提取共用UI组件 ✅
- 创建了 `DataTable` 组件用于数据展示，支持排序和分页
- 开发了表单组件系列：`Form`、`FormItem`、`Input`、`TextArea`、`Select`、`Checkbox`、`Radio`等
- 实现了 `Button` 和 `IconButton` 组件，支持多种样式和状态
- 创建了 `Card` 组件及其子组件用于内容展示
- 添加了 `Alert` 组件用于消息提示
- 实现了 `Modal` 和 `ConfirmModal` 组件用于对话框
- 开发了 `Tabs` 组件用于标签页切换
- 创建了 `Pagination` 组件用于分页控制
- 添加了 `Empty` 组件用于空状态展示

#### 创建标准布局组件 🔄
- 创建了 `AppLayout` 组件作为应用主布局
- 开发了 `AuthenticatedLayout` 组件用于认证用户
- 实现了 `ConsultantLayout` 组件用于顾问专用页面
- 添加了 `ClientLayout` 组件用于客户专用页面
- 创建了 `AdminLayout` 组件用于管理员页面

#### 优化组件以支持国际化 ✅
- 创建了 `useI18n` 工具函数
- 更新了所有UI组件以使用翻译函数
- 创建了 `LanguageSwitcher` 组件
- 为所有组件添加了翻译键
- 完成了英文和简体中文翻译文件

#### 统一加载状态指示器 ✅
- 创建了 `LoadingScreen` 组件用于显示全屏加载状态
- 支持自定义加载消息
- 使用一致的动画和样式

#### 全局错误处理组件 ✅
- 创建了 `ErrorBoundary` 组件捕获React组件树中的错误
- 提供了用户友好的错误UI
- 添加了错误日志记录功能
- 提供了页面刷新选项

#### 统一组件导出方式 🔄
- 将所有组件改为使用命名导出
- 移除默认导出
- 更新导入语句以使用命名导入

### 3. 状态管理优化

#### 引入React Query 🔄
- 添加了 `@tanstack/react-query` 依赖
- 创建了查询客户端配置
- 开发了基础数据获取hooks
- 实现了缓存策略

#### 创建可复用的自定义hooks 🔄
- 创建了 `useToast` hook用于消息提示
- 开发了 `useForm` hook用于表单处理
- 实现了 `useModal` hook用于模态框控制
- 添加了 `usePermission` hook用于权限检查
- 创建了 `useLocalStorage` hook用于本地存储
- 开发了 `useMediaQuery` hook用于响应式设计

#### 优化组件渲染性能 🔄
- 使用 `React.memo` 优化组件，减少不必要的重渲染
- 实现 `useMemo` 和 `useCallback` 优化计算和回调函数
- 添加了 `useTransition` 处理大型状态更新
- 优化了列表渲染性能

### 4. 国际化完善

#### 移除硬编码文本 ✅
- 扫描并移除了所有组件中的硬编码文本
- 将所有文本替换为翻译函数调用
- 为动态内容创建了翻译模板

#### 完善翻译文件 🔄
- 创建了英文(en)和简体中文(zh-CN)翻译文件
- 正在添加繁体中文(zh-TW)、法语(fr)、日语(ja)、韩语(ko)和阿拉伯语(ar)翻译
- 为翻译人员添加了上下文注释

#### 实现语言切换功能 ✅
- 创建了 `LanguageSwitcher` 组件
- 实现了语言偏好保存到本地存储
- 添加了自动检测浏览器语言功能
- 确保语言切换后UI立即更新

#### 支持RTL布局 🔄
- 创建了 `RTLWrapper` 组件处理文本方向
- 添加了RTL特定样式
- 优化了组件以支持RTL布局
- 为阿拉伯语等RTL语言添加了特殊处理

#### 支持日期、数字等本地化格式 ✅
- 使用 `Intl.DateTimeFormat` 实现日期本地化
- 使用 `Intl.NumberFormat` 实现数字本地化
- 创建了 `formatDate` 和 `formatNumber` 工具函数
- 支持货币、百分比等特殊格式

#### 重构翻译文件结构 ✅
- 将翻译文件按页面组织，而非按功能模块
- 为每个页面创建独立的翻译文件
- 创建了共享翻译文件用于通用组件
- 优化了翻译键命名规则
- 实现了翻译文件的按需加载

### 5. 响应式设计优化

#### 修复移动端布局问题 🔄
- 审查并修复了主要页面的移动端布局
- 优化了导航栏在小屏幕上的显示
- 调整了内容间距和字体大小
- 实现了更合理的元素堆叠

#### 优化表格在小屏幕上的显示 🔄
- 为 `DataTable` 组件添加了响应式设计
- 实现了表格列的优先级显示
- 添加了水平滚动支持
- 创建了卡片式表格视图用于极小屏幕

#### 实现更好的触摸体验 🔄
- 优化了按钮和表单控件的触摸区域
- 增加了触摸反馈效果
- 调整了交互元素的间距
- 优化了拖拽操作

### 6. 用户体验改进

#### 增强表单验证与反馈 🔄
- 创建了 `FormField` 组件，实现了统一的表单验证与反馈
- 添加了实时验证功能
- 优化了错误消息显示
- 实现了表单提交状态反馈

#### 优化状态转换的视觉反馈 🔄
- 创建了 `ActionButton` 组件，提供加载状态视觉反馈
- 添加了页面过渡动画
- 实现了数据加载骨架屏
- 优化了成功/失败状态的视觉反馈

#### 改进导航结构 [ ]
- 重新设计主导航菜单
- 优化移动端导航体验
- 添加面包屑导航
- 实现上下文感知的导航项

#### 实现更直观的错误提示 [ ]
- 设计用户友好的错误页面
- 添加错误恢复建议
- 实现上下文相关的错误消息
- 优化表单错误提示

## 🛠 技术债务清单

1. **重复代码** ✅
   - ~~`_app.tsx` 中的 `AuthenticatedApp` 组件重复定义~~ (已解决)
   - ~~多处相似的表格和表单实现~~ (已解决)
   - 分散的错误处理逻辑

2. **不一致的API路径** ✅
   - ~~`/api/user/role.ts` vs `/api/users/role.ts`~~ (已解决)
   - 不同的API响应格式

3. **硬编码文本** ✅
   - ~~大量页面包含硬编码的中文文本~~ (已解决)
   - ~~缺少完整的翻译文件~~ (部分解决)
   - ~~UI组件中的硬编码文本~~ (已解决)

4. **不一致的导出方式** 🔄
   - 混合使用默认导出和命名导出 (正在解决)
   - 导致导入方式不一致

5. **大型组件文件**
   - 某些页面组件超过500行代码
   - 业务逻辑和UI渲染混合

6. **缺少测试**
   - 没有单元测试
   - 没有端到端测试

## 📝 重构指南

### 代码风格与最佳实践

1. **组件结构**
   - 使用函数组件和Hooks
   - 将大型组件拆分为更小的子组件
   - 分离业务逻辑和UI渲染

2. **导出与导入规范**
   - 统一使用命名导出 (export const Component)
   - 避免使用默认导出 (export default)
   - 使用命名导入 (import { Component } from './path')

3. **状态管理**
   - 使用React Query进行服务器状态管理
   - 使用Context API进行全局状态
   - 使用useReducer处理复杂状态

4. **错误处理**
   - 使用全局错误边界
   - 统一错误提示UI
   - 记录错误但不暴露敏感信息

5. **性能优化**
   - 使用React.memo避免不必要的重渲染
   - 实现虚拟滚动处理大列表
   - 使用懒加载减少初始加载时间

6. **国际化最佳实践**
   - 使用翻译键而非直接文本
   - 避免在字符串中拼接文本
   - 按页面组织翻译文件
   - 支持复数形式和上下文
   - 支持RTL语言（阿拉伯语等）
   - 使用占位符处理动态内容
   - 为翻译人员提供上下文注释

## 🔄 后续更新计划

本文档将作为重构进度的持续追踪工具。团队成员应在完成任务时更新相关进度信息，并记录遇到的问题和解决方案。

## 📅 调整后的时间表

根据当前进度和优先级调整，更新后的时间表如下：

### 近期优先任务 (2024-06-26 至 2024-07-05)
1. **完成认证页面重构** - 预计2024-07-01完成
   - 登录页面
   - 注册页面
   - 密码重置页面
   - 账户验证页面

2. **完成状态管理优化** - 预计2024-07-03完成
   - 完成React Query实现
   - 完成自定义hooks开发
   - 优化组件渲染性能

3. **开始用户管理界面重构** - 预计2024-07-05开始
   - 用户资料设置页面
   - 账户管理页面
   - 订阅管理页面

### 中期任务 (2024-07-06 至 2024-07-20)
1. **完成用户管理界面重构** - 预计2024-07-12完成
2. **开始主登陆页面重构** - 预计2024-07-15开始
3. **完成响应式设计优化** - 预计2024-07-18完成

### 长期任务 (2024-07-21 至 2024-08-15)
1. **完成主登陆页面重构** - 预计2024-07-28完成
2. **开始顾问仪表盘与客户管理界面** - 预计2024-08-01开始
3. **开始安全与性能优化** - 预计2024-08-05开始
4. **开始测试覆盖** - 预计2024-08-10开始

## 🚧 当前阻碍与解决方案

1. **RTL支持复杂性**
   - **问题**: 某些组件在RTL模式下布局异常
   - **解决方案**: 创建专用的RTL测试环境，逐一测试并修复组件

2. **认证页面与Clerk集成**
   - **问题**: 自定义UI与Clerk认证流程集成存在挑战
   - **解决方案**: 创建适配层处理Clerk API与自定义UI之间的交互

3. **翻译文件管理**
   - **问题**: 随着应用增长，翻译键数量激增
   - **解决方案**: 实现按页面组织翻译文件，创建翻译管理工具

4. **翻译键显示问题** [新增]
   - **问题**: 页面显示翻译键而非实际翻译内容
   - **解决方案**: 调整翻译文件结构，确保与代码中使用的翻译键匹配

---

**负责人:** ThinkForward开发团队  
**联系方式:** dev@thinkforward.example.com

